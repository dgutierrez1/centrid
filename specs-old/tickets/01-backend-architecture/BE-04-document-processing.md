# BE-04: Document Processing Edge Function

**Status**: `pending`  
**Estimate**: 5 hours  
**Priority**: Critical  
**Dependencies**: BE-02

## Description

Create Edge Function to process uploaded documents (.md, .txt, .pdf), extract text, and store with full-text search indexing. No vector embeddings.

## Tasks

- [ ] Implement PDF text extraction
- [ ] Implement Markdown parsing
- [ ] Handle plain text files
- [ ] Create chunking logic (optional for MVP)
- [ ] Update document status in database
- [ ] Handle processing errors
- [ ] Test with various file types

## Tech Spec

### Document Processing Flow

```typescript
// supabase/functions/process-document/index.ts
import { PDFExtract } from "pdf.js-extract";

async function processDocument(fileUrl: string, fileType: string) {
  let text = "";

  // Extract text based on file type
  if (fileType === "pdf") {
    const pdf = await PDFExtract.extract(fileUrl);
    text = pdf.pages.map((p) => p.text).join("\n");
  } else if (fileType === "md" || fileType === "txt") {
    text = await fetch(fileUrl).then((r) => r.text());
  }

  // Store in database (search_vector auto-generated by trigger)
  await supabase
    .from("documents")
    .update({
      content_text: text,
      processing_status: "completed",
    })
    .eq("id", documentId);
}
```

### Storage Trigger

```sql
-- Trigger to process documents on upload
CREATE OR REPLACE FUNCTION trigger_document_processing()
RETURNS TRIGGER AS $$
BEGIN
  -- Call Edge Function via pg_net
  PERFORM net.http_post(
    url := 'https://xxx.supabase.co/functions/v1/process-document',
    body := json_build_object('document_id', NEW.id)::text
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

## Acceptance Criteria

- [ ] PDF text extraction working
- [ ] Markdown files processed correctly
- [ ] Plain text files working
- [ ] Processing status updates in real-time
- [ ] Errors logged and handled
- [ ] Files up to 10MB supported
- [ ] Full-text search works after processing

## Notes

- Use `pdf.js-extract` for PDF parsing
- Handle malformed PDFs gracefully
- Set timeout for large files
- Consider rate limiting

